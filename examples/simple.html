<script src="../lib/d3/d3.js"></script>
<script src="../d3.layout.compcloud.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<body>
<script>
	// Utility functions
	
	// May be useful
	function make_ngrams(words, n) {
		var ngrams = [];
		if (!n || n < 1) {
			n = 1;
		};
		for (var i = 0; i < words.length - (n - 1); i++) {
			temp = [];
			for (var j = i; j < i + n; j++) temp.push(words[j]);
			ngrams.push(temp)
		};
		return ngrams;
	}
	
	// I stole this
	function unique(array) {
		var o = {}, i, l = array.length,
			r = [];
		for (i = 0; i < l; i++) o[array[i]] = array[i];
		for (i in o) r.push(o[i]);
		return r;
	}

	var maxLength = 30;
	
	// From Jonathan Feinberg's cue.language, see lib/cue.language/license.txt.
	var stopWords = /^(i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)$/,
		punctuation = /[!"&()*+,-\.\/:;<=>?\[\\\]^`\{|\}~]+/g,
		wordSeparators = /[\s\u3031-\u3035\u309b\u309c\u30a0\u30fc\uff70]+/g,
		discard = /^(@|https?:)/,
		htmlTags = /(<[^>]*?>|<script.*?<\/script>|<style.*?<\/style>|<head.*?><\/head>)/g,
		matchTwitter = /^https?:\/\/([^\.]*\.)?twitter\.com/;

	function make_words(string) {
		common = [];
		words = string.trim().toLocaleLowerCase().replace(/[^-a-z0-9 ]/, "").split(/[^-a-z0-9]/).filter(function (word) {
			return word.length > 1
		}).filter(function (word) {
			return common.indexOf(word) < 0
		});
		return words;
	}
	
	function parseTexts(text1, text2) {
		var texts = [text1, text2].map(function(text) {
			tags = {}, cases = {};
			text.split(wordSeparators).forEach(function(word) {
				if (discard.test(word)) return;
				word = word.replace(punctuation, "");
				if (stopWords.test(word.toLowerCase())) return;
				word = word.substr(0, maxLength);
				cases[word.toLowerCase()] = word;
				tags[word = word.toLowerCase()] = (tags[word] || 0) + 1;
			});
			return tags;
		});
		var tags = function(first, second) {
			var words = unique(($.merge($.merge([], Object.keys(first)), Object.keys(second))));
			return words.map(function (w) {
				var c1 = first[w] || 0;
				var c2 = second[w] || 0;
				return {
					word: w,
					count1: c1,
					count2: c2,
					sum: c1 + c2,
					diff: (c1 - c2) / (c1 + c2),
				};
			});
		}(texts[0], texts[1]);
		tags = d3.entries(tags).sort(function(a, b) { return b.value.sum - a.value.sum });
	    return tags;
	}

	function color(x) {
		var max = 240;
		var min = 100;
		var step = (max - min) / 10;
		green = min;
		if (x < 0) {
			red = max;
			blue = ~~(max + step * 10*x);
		} else {
			blue = max;
			red = ~~(max - step * 10*x);
		}
		return "rgb(" + red + "," + green + "," + blue + ")";
	}

	d3.layout.compcloud().size([300, 300]).words(["returned", "and", "saw", "under", "the", "sun", "that", "race", "is", "not", "to", "swift", "nor", "battle", "strong", "neither", "yet", "bread", "wise", "riches", "men", "of", "understanding", "favour", "skill", "but", "time", "chance", "happeneth", "them", "all"].map(function (d) {
		return {
			text: d,
			size: 10 + Math.random() * 90,
			diff: Math.random() * 2 - 1
		};
	})).rotate(function () {
		return 0;
	}).fontSize(function (d) {
		return d.size;
	}).diff(function (d) {
		return Math.random() * 2 - 1;
	}).on("end", draw).start();

	function draw(words) {
		d3.select("body").append("svg").attr("width", 300).attr("height", 300).append("g").attr("transform", "translate(150,150)").selectAll("text").data(words).enter().append("text").style("font-size", function (d) {
			return d.size + "px";
		}).style("fill", function(d) {
			return color(d.diff);
		}).attr("text-anchor", "middle").attr("transform", function (d) {
			return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
		}).text(function (d) {
			return d.text;
		});
	}
</script>
